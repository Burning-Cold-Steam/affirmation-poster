<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poster</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0c10;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --border:rgba(255,255,255,.16);
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background:radial-gradient(900px 700px at 30% 20%,#1a2140 0%,var(--bg) 55%);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--text);
    }

    .wrap{width:min(980px,94vw)}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      padding:14px;
      display:grid;
      place-items:center;
    }

    /* Portrait-first poster: 9:16 always */
    .poster{
      width:min(520px, 96vw);
      aspect-ratio:9/16;
      position:relative;
      background:rgba(0,0,0,.25);
      border-radius:16px;
      overflow:hidden;
      user-select:none;
      touch-action:none;
    }
    @media(min-width:900px){
      .poster{ width:min(560px, 50vw); }
    }

    .stage{position:absolute; inset:0; overflow:hidden; z-index:1;}
    .stage img{
      position:absolute;
      left:50%; top:50%;
      transform-origin:center;
      max-width:none;
      pointer-events:none;
      -webkit-user-drag:none;
      filter: contrast(1.07) saturate(1.14) brightness(1.02) sepia(0.06);
    }

    .vignette{
      position:absolute; inset:0; pointer-events:none; z-index:3;
      background:
        radial-gradient(120% 110% at 50% 45%, rgba(0,0,0,0.00) 45%, rgba(0,0,0,0.42) 100%),
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.10));
    }
    .grain{
      position:absolute; inset:0; pointer-events:none; z-index:4;
      opacity:.08;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      background-size:180px 180px;
    }

    /* Affirmation (included in export) */
    .affirmation{
      position:absolute; left:16px; right:16px;
      bottom:18px;
      padding:16px 18px;
      text-align:center;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.34);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      z-index:10;

      opacity:0;
      transform:translateY(12px);
      transition:opacity .65s ease, transform .65s ease;
    }
    .reveal .affirmation{opacity:1; transform:none;}
    .affirmation .main{
      font-family:"Playfair Display", serif;
      font-size:clamp(26px,3.2vw,38px);
      font-weight:800;
      margin:0;
      line-height:1.12;
    }
    .affirmation .sub{
      margin:8px 0 0;
      color:rgba(255,255,255,.78);
      font-size:13px;
      line-height:1.25;
    }

    /* Upload overlay (NOT in export) */
    .uploadOverlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      padding:22px;
      background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.35));
      z-index:30;
    }
    .dropzone{
      width:min(520px,92%);
      border:1px dashed rgba(255,255,255,.25);
      border-radius:16px;
      padding:22px;
      text-align:center;
      background:rgba(255,255,255,.04);
    }
    .dropzone h2{margin:0 0 8px;font-size:18px;font-weight:750}
    .dropzone p{margin:0 0 14px;color:var(--muted);font-size:14px;line-height:1.35}

    button{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.2px;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    button:hover{background:rgba(255,255,255,.11)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}

    /* Controls (NOT in export) */
    .controls{
      position:absolute;
      left:14px; right:14px;
      bottom:calc(14px + env(safe-area-inset-bottom));
      display:none;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      z-index:40;
    }
    .loaded .controls{display:flex}
    @media(min-width:900px){
      .controls{
        top:14px; bottom:auto;
        justify-content:flex-end;
      }
    }

    /* Busy overlay (NOT in export) */
    .busyOverlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      z-index:50;
      background:rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease;
    }
    .busyOverlay.show{opacity:1; pointer-events:auto;}
    .busyCard{
      width:min(360px, 88%);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      border-radius:16px;
      padding:16px;
      text-align:center;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .busyTitle{margin:0 0 6px; font-weight:800; font-size:14px}
    .busyText{margin:0; color:rgba(255,255,255,.75); font-size:13px; line-height:1.25}
    .spinner{
      width:18px; height:18px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color:rgba(255,255,255,.85);
      margin:10px auto 0;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* In-page preview for mobile saving/sharing */
    .preview{
      position:fixed; inset:0;
      background:rgba(0,0,0,.92);
      display:none;
      flex-direction:column;
      z-index:9999;
      padding:14px;
      overflow:auto;
    }
    .preview.show{display:flex}
    .pvTop{
      position:sticky; top:0;
      background:rgba(0,0,0,.82);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.12);
      padding:10px 0 12px;
      margin-bottom:12px;
    }
    .pvRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      max-width:900px; margin:0 auto;
    }
    .pvText h3{margin:0 0 4px; font-size:14px; font-weight:850}
    .pvText p{margin:0; font-size:12px; color:rgba(255,255,255,.78); line-height:1.35}
    .pvBtns{display:flex; gap:10px; flex-wrap:wrap;}
    .pvImgWrap{display:grid; place-items:center; max-width:900px; margin:0 auto 30px;}
    .pvImg{max-width:100%; height:auto; border-radius:14px; border:1px solid rgba(255,255,255,.12);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div id="poster" class="poster">

        <div class="stage">
          <img id="photo" alt="" />
        </div>

        <div class="vignette"></div>
        <div class="grain"></div>

        <div class="affirmation" aria-live="polite">
          <p class="main" id="affirmMain"></p>
          <p class="sub" id="affirmSub"></p>
        </div>

        <!-- Controls excluded from export -->
        <div class="controls" id="controls" data-html2canvas-ignore="true">
          <button type="button" id="fitBtn" disabled>Fit</button>
          <button type="button" id="retryBtn" disabled>Retry</button>
          <button type="button" id="exportBtn" disabled>Export PNG</button>
        </div>

        <!-- Upload excluded from export -->
        <div class="uploadOverlay" id="uploadOverlay" data-html2canvas-ignore="true">
          <div class="dropzone" id="dropzone">
            <h2>Add your photo</h2>
            <p>Choose or drop an image. The message appears after the photo loads.</p>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
              <button type="button" id="chooseBtn">Choose image</button>
            </div>
            <input id="file" type="file" accept="image/*" hidden>
          </div>
        </div>

        <!-- Busy excluded from export -->
        <div class="busyOverlay" id="busy" data-html2canvas-ignore="true">
          <div class="busyCard">
            <p class="busyTitle">Preparing image…</p>
            <p class="busyText">On some phones this can take a moment.</p>
            <div class="spinner"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Preview overlay for mobile / fallback -->
  <div class="preview" id="preview" data-html2canvas-ignore="true">
    <div class="pvTop">
      <div class="pvRow">
        <div class="pvText">
          <h3>Save your poster</h3>
          <p>
            iPhone/iPad: press and hold the image → Save to Photos / Share.<br>
            Android: long-press → download/share.<br>
            Desktop: right-click → save image.
          </p>
        </div>
        <div class="pvBtns">
          <a id="pvDownload" href="#" download="poster.png"><button type="button">Try Download</button></a>
          <button type="button" id="pvClose">Close</button>
        </div>
      </div>
    </div>
    <div class="pvImgWrap">
      <img class="pvImg" id="pvImg" alt="Poster preview">
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const poster = document.getElementById('poster');
    const photo = document.getElementById('photo');
    const fileInput = document.getElementById('file');
    const chooseBtn = document.getElementById('chooseBtn');
    const dropzone = document.getElementById('dropzone');
    const uploadOverlay = document.getElementById('uploadOverlay');

    const controls = document.getElementById('controls');
    const fitBtn = document.getElementById('fitBtn');
    const retryBtn = document.getElementById('retryBtn');
    const exportBtn = document.getElementById('exportBtn');

    const busy = document.getElementById('busy');

    const affirmMain = document.getElementById('affirmMain');
    const affirmSub  = document.getElementById('affirmSub');

    const preview = document.getElementById('preview');
    const pvImg = document.getElementById('pvImg');
    const pvDownload = document.getElementById('pvDownload');
    const pvClose = document.getElementById('pvClose');

    const isIOS = /iPad|iPhone|iPod/i.test(navigator.userAgent) && !window.MSStream;
    const isAndroid = /Android/i.test(navigator.userAgent);

    let currentObjectURL = null;

    // Transform state
    let scale = 1, x = 0, y = 0;
    let baseScale = 1, minScale = 0.2, maxScale = 3.0;

    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function apply(){
      photo.style.transform = `translate(-50%,-50%) translate(${x}px,${y}px) scale(${scale})`;
    }
    function computeContainScale(){
      const pw = poster.clientWidth, ph = poster.clientHeight;
      const iw = photo.naturalWidth || 1, ih = photo.naturalHeight || 1;
      return Math.min(pw / iw, ph / ih) * 0.98;
    }
    function fitToScreen(){
      x = 0; y = 0;
      baseScale = computeContainScale();
      scale = baseScale;
      minScale = baseScale * 0.35;
      maxScale = Math.max(3.0, baseScale * 6);
      apply();
      resetGestureBaseline();
    }

    // Affirmations (~30)
    const MORNING = [
      { main: "This person is allowed a gentle start.", sub: "You don’t need to rush to be worthy." },
      { main: "This person is doing better than they think.", sub: "Even small steps count." },
      { main: "This person deserves a calm morning.", sub: "Softness is strength." },
      { main: "This person can begin again.", sub: "Fresh doesn’t have to be loud." },
      { main: "This person is capable today.", sub: "One thing at a time." },
      { main: "This person is enough already.", sub: "Before they prove anything." },
      { main: "This person matters.", sub: "More than they realise." },
      { main: "This person is worthy of good things.", sub: "No conditions attached." }
    ];
    const AFTERNOON = [
      { main: "This person’s effort matters.", sub: "Especially the unseen parts." },
      { main: "This person is learning, not failing.", sub: "Growth looks messy sometimes." },
      { main: "This person deserves kindness today.", sub: "From others — and themselves." },
      { main: "This person can take up space.", sub: "They were never ‘too much’." },
      { main: "This person is more capable than they feel.", sub: "Feelings are not facts." },
      { main: "This person is loved and appreciated.", sub: "More than they know." },
      { main: "This person belongs.", sub: "There is space for you here." },
      { main: "This person’s pace is the right pace.", sub: "Life isn’t a race." }
    ];
    const EVENING = [
      { main: "This person did enough for one day.", sub: "Rest is part of the work." },
      { main: "This person deserves gentleness.", sub: "Especially from themselves." },
      { main: "This person is safe to slow down.", sub: "Nothing needs proving tonight." },
      { main: "This person is proud-worthy.", sub: "Even for simply getting through." },
      { main: "This person is seen.", sub: "Even when they feel invisible." },
      { main: "This person is enough.", sub: "Right now. As-is." },
      { main: "This person is held in good regard.", sub: "More than they realise." }
    ];
    const LATE = [
      { main: "This person is allowed to rest.", sub: "Worth is not earned through exhaustion." },
      { main: "This person is not a burden.", sub: "They never were." },
      { main: "This person has survived everything so far.", sub: "That counts for something." },
      { main: "This person’s story isn’t finished.", sub: "There’s more ahead." },
      { main: "This person deserves peace.", sub: "Even if it starts small." },
      { main: "This person is worthy, exactly as they are.", sub: "No performance required." },
      { main: "This person is stronger than the hard days.", sub: "Quiet strength still counts." }
    ];

    function dayPart(){
      const h = new Date().getHours();
      if (h >= 5 && h < 12) return "morning";
      if (h >= 12 && h < 17) return "afternoon";
      if (h >= 17 && h < 22) return "evening";
      return "late";
    }
    function pickAffirmation(){
      const p = dayPart();
      const pool = (p === "morning") ? MORNING
                 : (p === "afternoon") ? AFTERNOON
                 : (p === "evening") ? EVENING
                 : LATE;
      const pick = pool[Math.floor(Math.random() * pool.length)];
      affirmMain.textContent = pick.main;
      affirmSub.textContent  = pick.sub;
    }

    // One-time timers (reveal after 6s; retry after 20s optional removed here)
    let timersStarted = false;
    function startTimers(){
      if (timersStarted) return;
      timersStarted = true;
      poster.classList.remove('reveal');
      setTimeout(() => poster.classList.add('reveal'), 6000);
    }

    function showBusy(){ busy.classList.add('show'); }
    function hideBusy(){ busy.classList.remove('show'); }

    // Upload
    chooseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) loadImageFast(f);
    });
    dropzone.addEventListener('dragover', (e) => e.preventDefault());
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) loadImageFast(f);
    });

    async function loadImageFast(fileObj){
      pickAffirmation();

      if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
      currentObjectURL = URL.createObjectURL(fileObj);

      photo.onload = () => {
        uploadOverlay.style.display = 'none';
        controls.classList.add('show');
        poster.classList.add('loaded');

        fitBtn.disabled = false;
        retryBtn.disabled = false;
        exportBtn.disabled = false;

        fitToScreen();
        startTimers();
      };

      photo.src = currentObjectURL;
      photo.alt = "User photo";
    }

    fitBtn.addEventListener('click', () => {
      if(!poster.classList.contains('loaded')) return;
      fitToScreen();
    });

    retryBtn.addEventListener('click', () => {
      if(!poster.classList.contains('loaded')) return;
      pickAffirmation();
    });

    // Gestures
    const pointers = new Map();
    let lastPinchDist = null;

    const DRAG_SENS = isIOS ? 0.45 : 1.0;
    const PINCH_SENS = isIOS ? 0.18 : 1.0;
    const PINCH_DEADZONE = isIOS ? 0.012 : 0.0;
    const MAX_SCALE_STEP = isIOS ? 0.020 : 0.06;

    let needsApply = false;
    function scheduleApply(){
      if (needsApply) return;
      needsApply = true;
      requestAnimationFrame(() => { needsApply = false; apply(); });
    }

    function getDist(a, b){
      const dx = a.clientX - b.clientX;
      const dy = a.clientY - b.clientY;
      return Math.hypot(dx, dy);
    }
    function resetGestureBaseline(){
      pointers.clear();
      lastPinchDist = null;
    }

    poster.addEventListener('pointerdown', (e) => {
      if (!poster.classList.contains('loaded')) return;
      if (e.target.closest('button') || e.target.closest('input')) return;

      pointers.set(e.pointerId, { clientX: e.clientX, clientY: e.clientY });
      poster.setPointerCapture?.(e.pointerId);

      if (pointers.size === 2){
        const [p1, p2] = Array.from(pointers.values());
        lastPinchDist = getDist(p1, p2);
      }
    });

    poster.addEventListener('pointermove', (e) => {
      if(!pointers.has(e.pointerId)) return;

      const prev = pointers.get(e.pointerId);
      const curr = { clientX: e.clientX, clientY: e.clientY };
      pointers.set(e.pointerId, curr);

      if (pointers.size === 1){
        x += (curr.clientX - prev.clientX) * DRAG_SENS;
        y += (curr.clientY - prev.clientY) * DRAG_SENS;
        scheduleApply();
        return;
      }

      if (pointers.size === 2){
        const [p1, p2] = Array.from(pointers.values());
        const dist = getDist(p1, p2);

        if (!lastPinchDist){
          lastPinchDist = dist;
          return;
        }

        const rawRatio = dist / lastPinchDist;
        lastPinchDist = dist;

        if (Math.abs(rawRatio - 1) < PINCH_DEADZONE) return;

        const intendedRatio = 1 + ((rawRatio - 1) * PINCH_SENS);

        let nextScale = scale * intendedRatio;
        const delta = nextScale - scale;
        const clampedDelta = clamp(delta, -MAX_SCALE_STEP, MAX_SCALE_STEP);

        scale = clamp(scale + clampedDelta, minScale, maxScale);
        scheduleApply();
      }
    });

    function endPointer(e){
      pointers.delete(e.pointerId);
      if (pointers.size < 2) lastPinchDist = null;
      poster.releasePointerCapture?.(e.pointerId);
    }
    poster.addEventListener('pointerup', endPointer);
    poster.addEventListener('pointercancel', endPointer);

    poster.addEventListener('wheel', (e) => {
      if(!poster.classList.contains('loaded')) return;
      e.preventDefault();
      const delta = -Math.sign(e.deltaY);
      const factor = (delta > 0) ? 1.08 : 0.92;
      scale = clamp(scale * factor, minScale, maxScale);
      apply();
    }, { passive:false });

    // Export (critical: excludes UI via data-html2canvas-ignore)
    function openPreview(dataUrl){
      pvImg.src = dataUrl;
      pvDownload.href = dataUrl;
      preview.classList.add('show');
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }
    function closePreview(){
      preview.classList.remove('show');
      pvImg.src = "";
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }
    pvClose.addEventListener('click', closePreview);
    preview.addEventListener('click', (e) => { if (e.target === preview) closePreview(); });

    async function exportPNG(){
      if(!poster.classList.contains('loaded')) return;
      showBusy();

      // Fail-safe: never leave “Preparing…” stuck
      const safety = setTimeout(() => hideBusy(), 15000);

      try{
        // allow busy overlay to paint (it’s ignored in capture anyway)
        await new Promise(r => setTimeout(r, 60));

        const canvas = await html2canvas(poster, {
          scale: 2,
          backgroundColor: "#0b0c10",
          useCORS: true,
          logging: false
        });

        const dataUrl = canvas.toDataURL("image/png");

        // Desktop: direct download
        if (!isIOS && !isAndroid){
          const a = document.createElement('a');
          a.href = dataUrl;
          a.download = "poster.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
          return;
        }

        // Mobile: preview (reliable save/share)
        openPreview(dataUrl);
      } finally {
        clearTimeout(safety);
        hideBusy();
      }
    }

    exportBtn.addEventListener('click', exportPNG);
  </script>
</body>
</html>
